package malwaresimulator.engine.nodes

import akka.actor.typed.Behavior
import akka.actor.typed.scaladsl.Behaviors
import malwaresimulator.engine.core.{Datagram, InetAddress, Message}
import malwaresimulator.engine.{TraceLogger, nodes}
import scala.collection.mutable.ListBuffer

abstract trait Firewall extends NetworkNode {
  var firewallRules: ListBuffer[FirewallRule] = ListBuffer.empty
  val name: String
  /**
   * 新しいファイアウォールルールを追加する
   * @param newRule 新しいファイアウォールルール
   */
  def addRule(newRule: FirewallRule): Unit = {
    firewallRules += newRule
    TraceLogger.info(name, "added new rule!")
  }

  /**
   * ファイアウォールルールでdenyに指定されているかをチェックする
   * @param d ルールと照らし合わせるデータグラム
   * @return true  denyに指定されている
   * @return false denyに指定されていない
   */
  def checkDenyDatagram(d: Datagram): Boolean = {
    val matchDatagram = nodes.FirewallRule("deny",
      d.srcAddress,
      d.srcPort,
      d.dstAddress,
      d.dstPort)
    TraceLogger.info(name, s"matchDatagram: $matchDatagram" , d)
    firewallRules.find(check => check == matchDatagram) match {
      case Some(check) => { TraceLogger.info(name, "deny!", d); true }
      case None => false
    }
  }

  /**
   *  自分宛のデータグラムならば受け取り，アプリケーションがあればそこに送る
   *  自分宛では無くルーティング可能なら該当ネットワークにデータグラムを転送
   *  ただしファイアウォールルールによって転送するか破棄するかを決める
   *  @param d 受け取るデータグラム
   */
  override def networkResponse(d: Datagram): Unit = {
    val destAddress: InetAddress = d.dstAddress // 行き先アドレス

    if (!checkDenyDatagram(d)) {
      if (connections.filter(_.address == destAddress).nonEmpty) {
        // 設定されている接続のうちひとつでも行き先アドレスのものがあったら
        TraceLogger.info(name, "received a Datagram", d)
        receiveDatagram(d) // データグラムを受け取る
      } else {
        TraceLogger.info(name, "NetworkNode has to deliver a datagram", d)
        // 行き先が同じネットワークに接続されているものがあればルーティング
        // する必要がないので，直接送信する
        connections.find(con => { con.address == d.dstAddress })
        match {
          case Some(con) => (con.network) ! d
          case None => deliverDatagram(d)
        }
      }
    } else { TraceLogger.info(name, "Packet is denied!", d) }
  }

}
