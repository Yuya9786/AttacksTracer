package malwaresimulator.engine

import scala.annotation.tailrec
import scala.collection.mutable.ListBuffer
import scala.collection.mutable.HashMap
import scala.util.Random
import core.Datagram
import malwaresimulator.engine.networks.Network

sealed trait EventType
object EventType {
  case object Action extends EventType
  case object Info extends EventType
  case object Error extends EventType
}

trait Event {
  val eventType: EventType
}

sealed trait ActorType
object ActorType {
  case object Network extends ActorType
  case object Node extends ActorType
  case object Application extends ActorType
}


/**
 * アクターで起こった通信
 *
 * @param eventType
 * @param actorName
 * @param message
 * @param datagram
 */
case class DatagramEvent(eventType: EventType, actorType: ActorType, actorName: String,
                         message: String, datagram: Datagram) extends Event {
  // TODO 変数の有無で出力を変える
  override def toString: String = s"$eventType:[$actorType:$actorName, $message] => $datagram"
}

/**
 * アクターで呼ばれた処理
 *
 * @param eventType
 * @param message
 */
case class ActionEvent(eventType: EventType, actorType: ActorType, actorName: String, message: String) extends Event {
  override def toString: String = s"$eventType:[$actorType:$actorName]=$message"
}

/**
 * シミュレートで発生した事象をまとめたログ
 */
case class EventLog(events: List[Event]) // TODO 出力用のメソッドを用意する(summary, datagramメソッドなど), シミュレートの実行時間も持たせる？

/**
 * アクターでのアクションを事象ごとで収集するLoggerオブジェクト
 */
object TraceLogger {
  private[this] var lastId: Long = 0

  private[this] var resultMap: HashMap[Long, ListBuffer[Event]] = HashMap.empty

  private[this] val random = new Random

  @tailrec
  def start: Long = {
    // 0を含まない自然数
    val id = random.nextLong.abs + 1
    if (resultMap.contains(id)) {
      start
    } else {
      resultMap += (id -> ListBuffer.empty)
      lastId = id
      id
    }
  }

  def stop(id: Long): Option[EventLog] = {
    resultMap.get(id) match {
      case Some(list) => Some(EventLog(list.toList))
      case None       => None
    }
  }

  private[this] def appendDatagramLog(id: Long, eventType: EventType, actorType: ActorType, actorName: String, message: String, d: Datagram): Unit = {
    val event = DatagramEvent(eventType, actorType, actorName, message, d)
    appendLog(id, event)
  }

  private[this] def appendActionLog(id: Long, eventType: EventType, actorType: ActorType, actorName: String, message: String): Unit = {
    val event = ActionEvent(eventType, actorType, actorName, message)
    appendLog(id, event)
  }

  private[this] def appendLog(id: Long, event: Event): Unit = {
    resultMap.get(id) match {
      case Some(list) => list += event
      // ログを記録しないで出力する. (OperationToolとの互換性のため)
      case None => println(event.toString)
    }
  }

  def info(id: Long, actorType: ActorType, taskName: String): Unit = {
    val event = ActionEvent(EventType.Action, actorType, "Action", taskName)
    appendLog(id, event)
  }

  protected[engine] def info(id: Long, actorType: ActorType, actorName: String, message: String): Unit =
    appendActionLog(id, EventType.Info, actorType, actorName, message)

  protected[engine] def info(actorType: ActorType, actorName: String, message: String): Unit =
    info(lastId, actorType, actorName, message)

  protected[engine] def error(id: Long, actorType: ActorType, actorName: String, message: String): Unit =
    appendActionLog(id, EventType.Error, actorType, actorName, message)

  protected[engine] def error(actorType: ActorType, actorName: String, message: String): Unit =
    error(lastId, actorType, actorName, message)

  // DatagramLog
  protected[engine] def info(id: Long, actorType: ActorType, actorName: String, message: String, d: Datagram): Unit =
    appendDatagramLog(id, EventType.Info, actorType, actorName, message, d)

  protected[engine] def info(actorType: ActorType, actorName: String, message: String, d: Datagram): Unit =
    info(lastId, actorType, actorName, message, d)

  protected[engine] def info(actorType: ActorType, actorName: String, d: Datagram): Unit =
    info(lastId, actorType, actorName, null, d)

  protected[engine] def error(id: Long, actorType: ActorType, actorName: String, message: String, d: Datagram): Unit =
    appendDatagramLog(id, EventType.Error, actorType, actorName, message, d)

  protected[engine] def error(actorType: ActorType, actorName: String, message: String, d: Datagram): Unit =
    error(lastId, actorType, actorName, message, d)

  protected[engine] def error(actorType: ActorType, actorName: String, d: Datagram): Unit =
    error(lastId, actorType, actorName, null, d)
}

